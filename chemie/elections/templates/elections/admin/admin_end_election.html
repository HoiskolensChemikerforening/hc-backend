{% extends "chemie/base_election.html" %}
{% load static %}


{% block header %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

<link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.28.9/css/theme.materialize.min.css">
<script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.28.9/js/jquery.tablesorter.min.js"></script>
<script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.28.9/js/widgets/widget-output.min.js"></script>
<script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.28.9/js/jquery.tablesorter.widgets.js"></script>
<script>
    $(function () {
        var $table = $('table');
        $('.download').click(function () {
            // tell the output widget do it's thing
            $table.trigger('outputTable');
        });

        $table.tablesorter({
            theme: "materialize",
            widgets: ['zebra', 'output'],
            widgetOptions: {
                output_delivery: 'd',
                zebra: ["even", "odd"],
                output_saveFileName: 'Valg_{{election.date}}.csv'
            }
        });
    });
    const numberOfVoterListPre = "{{voter_list}}";
    const numberOfVoterList = numberOfVoterListPre.replace("[", '').replace("]", '').split(',');
    const totalVotesPre = "{{total_votes}}";
    const totalVotes = totalVotesPre.replace("[", '').replace("]", '').split(',');
    const blankVotesPre = "{{blank_votes}}";
    const blankVotes = blankVotesPre.replace("[", '').replace("]", '').split(',');
</script>

<style>
    .tablesorter-materialize .tablesorter-filter-row input.tablesorter-filter,
    .tablesorter-materialize .tablesorter-filter-row select.tablesorter-filter {
        margin: 0 0 10px 0 !important;
    }

    .select-wrapper input.select-dropdown {
        margin: 0 0 10px 0 !important;
    }

    .tablesorter-materialize tfoot td,
    .tablesorter-materialize tfoot th,
    .tablesorter-materialize thead td,
    .tablesorter-materialize thead th {
        background-color: transparent !important;
    }

    .tablesorter-materialize .tablesorter-filter-row {
        background-color: transparent !important;
    }

    ul {
        padding-left: 20px;
    }

    #foo.hide2 tr>*:nth-child(2) {
        display: none;
    }
</style>
{% endblock header %}


{% block content %}

<div class="alert alert-info" style="text-align:center">
    <strong>Valget er stengt!</strong> Du kan laste ned valgresultatene!
</div>
<div style="margin:4rem; text-align: center">
    <button class="download btn btn-secondary">Last ned</button>
</div>
<div class="d-flex flex-wrap" style="margin:1rem">
    {%for position in positions %}
    <div class="p-2" style="margin:1rem; width:20rem; border-style: solid; border-radius: 1rem">
        <div class=" flex flex-column">
            <div class="p-1">
                <h5>{{position}}</h5>
            </div>
            <div class="p-1" style="border-style:solid none solid none;">
                <ul>
                    <li id="list-number-voters-{{position.id}}">
                        -
                    </li>
                    <li id="list-total-votes-{{position.id}}">
                        -
                    </li>
                    <li id="list-blank-votes-{{position.id}}">
                        -
                    </li>
                    <script type="text/javascript">
                        var posID = "{{ position.id }}"
                        var positionIter = parseInt("{{ forloop.counter }}") - 1
                        document.getElementById("list-number-voters-" + posID).innerHTML = "Antall personer stemt: " + numberOfVoterList[positionIter].bold()
                        document.getElementById("list-total-votes-" + posID).innerHTML = "Totale stemmer: " + totalVotes[positionIter].bold()
                        document.getElementById("list-blank-votes-" + posID).innerHTML = "Blanke stemmer: " + blankVotes[positionIter].bold()
                    </script>
                </ul>


            </div>
            <div class="p-1">
                <ul>
                    {%for candidate in position.candidates.all%}

                    <li id="cadidate-votes-{{candidate.id}}">-</li>
                    <script>
                        var candPreVotes = parseInt("{{candidate.pre_votes}}")
                        var candVotes = parseInt("{{candidate.votes}}")
                        var candidateName = "{{candidate}}"
                        var candTotalVotes = (candPreVotes + candVotes).toString()
                        var message = candidateName + ": " + candTotalVotes.bold()
                        document.getElementById("cadidate-votes-{{candidate.id}}").innerHTML = message;
                    </script>
                    </li>
                    {%endfor%}
                </ul>
            </div>
        </div>
    </div>
    {%endfor%}

</div>
<div class="row" style="">
    <div class="col s12 m12 l10">
        <table id="myTable" class="tablesorter">
            <thead>
                <tr>
                    <th>Verv</th>
                    <th>Kandidat</th>
                    <th>Forhaandstemmer</th>
                    <th>Avgitte stemmer</th>
                    <th>Totale stemmer</th>
                </tr>
            </thead>

            <tbody>
                {% for position in positions %}
                <tr>
                    <th>{{position.position_name}}</th>
                    <th>Totale stemmer</th>
                    <th>-</th>
                    <th>-</th>
                    <th>
                        <p id="total-votes-{{position.id}}">
                            -
                        </p>
                    </th>
                </tr>
                <tr>
                    <th>{{position.position_name}}</th>
                    <th>Blanke stemmer</th>
                    <th>-</th>
                    <th>-</th>
                    <th>
                        <p id="blank-votes-{{position.id}}">
                            -
                        </p>
                    </th>
                </tr>
                <tr>
                    <th>{{position.position_name}}</th>
                    <th>Antall personer stemt</th>
                    <th>-</th>
                    <th>-</th>
                    <th>
                        <p id="number-voters-{{position.id}}">

                        </p>
                    </th>
                </tr>
                <script type="text/javascript">
                    var posID = "{{ position.id }}"
                    var positionIter = parseInt("{{ forloop.counter }}") - 1
                    document.getElementById("number-voters-" + posID).innerHTML = numberOfVoterList[positionIter]
                    document.getElementById("total-votes-" + posID).innerHTML = totalVotes[positionIter]
                    document.getElementById("blank-votes-" + posID).innerHTML = blankVotes[positionIter]
                </script>
                {%for candidate in position.candidates.all%}
                <tr>
                    <th>{{position.position_name}}</th>
                    <th>{{candidate}}</th>
                    <th>{{candidate.pre_votes}}</th>
                    <th>{{candidate.votes}}</th>
                    <th>
                        <p id="candidate-total-votes-{{candidate.id}}">
                            -
                        </p>
                    </th>
                    <script type="text/javascript">
                        var candPreVotes = parseInt("{{ candidate.pre_votes }}")
                        var candVotes = parseInt("{{ candidate.votes }}")
                        var candID = "{{ candidate.id }}"
                        var CandTotalVotes = (candPreVotes + candVotes).toString()
                        document.getElementById("candidate-total-votes-" + candID).innerHTML = CandTotalVotes
                    </script>
                </tr>
                {%endfor%}
                {% endfor %}

            </tbody>
        </table>
    </div>
</div>
{% endblock content %}

{% block footer_script %}
<script src="{% static 'js/boolean_status_widget.js' %}" type='text/javascript'></script>
<script>
    $(document).ready(function () {
        $('.payment').on('click', function (event) {
            //$('.payment').live('click', function(event){
            event.preventDefault();
            var myID = $(this).attr("id").split('-')[1];
            var csrftoken = getCookie('csrftoken');
            $.ajax({
                type: "GET",
                url: "/events/social/adminlist/paymentstatus/" + myID,
                datatype: "json",

                success: function (json) {
                    icon_changer("#payment-" + myID, json.payment_status)
                },

                error: function (xhr, errmsg, err) {
                    // console.log(xhr.status + ": " + xhr.responseText);
                },
            });
        })

        $('.arrival').on('click', function (event) {
            event.preventDefault();
            var myID = $(this).attr("id").split('-')[1];
            var csrftoken = getCookie('csrftoken');
            $.ajax({
                type: "GET",
                url: "/events/bedpres/adminlist/arrivalstatus/" + myID,
                datatype: "json",

                success: function (json) {
                    icon_changer("#arrival-" + myID, json.arrival_status)
                },

                error: function (xhr, errmsg, err) {
                    //console.log(xhr.status + ": " + xhr.responseText);
                },
            });
        })
    });

</script>
{% endblock %}