{% extends "chemie/base.html" %}
{% load thumbnail %}

<head>
  <meta charset="UTF-8">
  <title>Chemshop</title>
</head>

{% block nav_header %}
Chemshop
{% endblock nav_header %}

{% block style %}
  .card-box {
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(250px, 1fr));
  }
  .card-box>* {
    flex: 1 1 160px;
    margin: 1rem;
  }
  .activator{
    max-width:50%;
    height:10rem;
    margin-left:auto;
    margin-right:auto;
    padding:10px;
  }
  .column {
    float: left;
    width: 50%;
    padding: 10px;
  }
  .item-close:hover {
    background-color: #f44336;
    color: white;
  }

  <!-- ¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤ -->
  /* Include the padding and border in an element's total width and height */
* {
  box-sizing: border-box;
}

/* Remove margins and padding from the list */
.ul-item-list {
  margin: 0;
  padding: 0;
}

/* Style the list items */
.item-list{
  cursor: pointer;
  position: relative;
  padding: 12px 8px 12px 40px;
  list-style-type: none;
  background: #eee;
  font-size: 18px;
  transition: 0.2s;
  
  /* make the list items unselectable */
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* Set all odd list items to a different color (zebra-stripes) */
.item-list:nth-child(odd) {
  background: #f9f9f9;
}

/* Darker background-color on hover */
.item-list:hover {
  background: #ddd;
}

/* Style the close button */
.item-close {
  position: absolute;
  right: 0;
  top: 0;
  padding: 12px 16px 12px 16px;
}
{% endblock style %}

{% block content %}
<script>
  // The dictionary is the equivalent shopping cart 
  var item_dict = {}
</script>

<div class="card-box">
  {% for item in items %}
  <div class="card sticky-action small">
    <div class="card-image waves-effect waves-block waves-light">
        {% thumbnail item.image "630x400" as pic %}
        <img class="activator" src="{{ pic.url }}">
        {% endthumbnail %}
    </div>

    <div class="card-content">
      <span class="card-title activator grey-text text-darken-4" style="float:left">{{ item.name }}</span>
      <span class="card-title activator grey-text text-darken-4" style="float:right; font-size: medium">{{ item.price }} kr</span>
    </div>

    <div class="card-action"> 
        <script type="text/javascript">
          item_dict["{{item.name}}"] = 0; // appends item to dictionary
          
          //user presses the + button
          function plus(item_name){
              item_dict[item_name]++;
              document.getElementById('item_'+ item_name).value = item_dict[item_name];
          }

          // user presses the - button
          function minus(item_name){
            if (item_dict[item_name]>0){
              item_dict[item_name]--;
            } 
            document.getElementById('item_'+ item_name).value = item_dict[item_name];
          }  
        </script>
        <div>
            <a type="button" class="btn-small waves-effect waves-light red" id="minus" onclick="minus('{{item.name}}')"><i class="material-icons white-text">remove</i></a>
            <input style="width: 1.2rem; text-align: center" type="text" value="0" id="item_{{item.name}}">
            <a type="button"  class="btn-small waves-effect waves-light green" id="plus" onclick="plus('{{item.name}}')"><i class="material-icons white-text" style="margin:auto">add</i></a>
            <form action="#" method="POST" style="display:inline; margin: auto">
                {% csrf_token %}
                <button class="waves-effect waves-light btn-small" id="{{ item.id }}" type="submit" name="buy" value="{{ item.id }}-0" style="float:right; margin-top: 0.5rem" onclick="changeQuantity(this,'{{item.name}}');"><i class="large material-icons">add_shopping_cart</i></button>
            </form>
        </div>  
    </div>
  </div>
  {% endfor %}
</div>
<div>
    <!-- Modal Structure -->
    <div id="modal1" class="modal">
      <div class="modal-content" id="cart-modal">
          <div>
              Din handlevogn inneholder:
              <ul class="ul-item-list">
              {% for item_names, item_details in cart.cart.items %}               
                <li class="item-list"id="item-list-{{item_names.pk}}">{{ item_names }},
                    Antall: {{item_details.quantity}},
                    Pris: {{item_details.price}}</li>
              {% endfor %}
              </ul>
              Total: {{ cart.get_total_price }}
            </div>
            <form method="POST"> {% csrf_token %}
                <button class="waves-effect waves-light btn" type="submit" name="checkout" value="checkout">Kjøp varer</button>
            </form>
      </div>
      <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Agree</a>
      </div>
    </div>
</div>
  {% if cart.cart %}
  <!-- floating shopping cart btn is styled with JS footer script -->
  <div class="fixed-action-btn" id="shopping-cart-btn" style="bottom: 3.05rem; left: 1.7rem;">
    <a class="btn-floating btn-large modal-trigger" href="#modal1">
      <i class="large material-icons yellow darken-2">shopping_cart</i>
    </a>
  </div>
{% endif %}
{% if perms.shop.add_item %}
<div class="fixed-action-btn" style="bottom: 45px; right: 24px;">
  <a class="btn-floating btn-large">
    <i class="large material-icons">edit</i>
  </a>
  <ul>
    <li>
      <a class="btn-floating blue" href="{% url "shop:add-item" %}"><i class="material-icons">add</i></a>
      <a class="btn-floating mobile-fab-tip">Opprett vare</a>
    </li>
    {% if perms.shop.add_category %}
    <li>
      <a class="btn-floating blue" href="{% url "shop:add-category" %}"><i class="material-icons">add</i></a>
      <a class="btn-floating mobile-fab-tip">Opprett kategori</a>
    </li>
    {% endif %}
    {% if perms.customprofile.can_refill_balance %}
    <li>
      <a class="btn-floating blue" href="{% url "shop:refill" %}"><i class="material-icons">add</i></a>
      <a class="btn-floating mobile-fab-tip">Fyll konto</a>
    </li>
    {% endif %}
  </ul>
</div>
{% endif %}
{% endblock content %}

{% block footer_script %}
<script>
  function changeQuantity(self, item_name) {
    if (item_dict[item_name] === 0){
      self.preventDefault();
      return false;
    }
    var id = self.getAttribute("id");
    self.setAttribute("value", id + "-" + item_dict[item_name]);
    return false;
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    var elems = document.querySelectorAll('.modal');
    var instances = M.Modal.init(elems, {});
  });
  
  // Check if side bar is activated or not
  var floatBtn = document.getElementById("shopping-cart-btn");
  if (window.innerWidth > 994) {
      floatBtn.setAttribute("style", "left:22.5rem; bottom: 3.1rem;");
  }


</script>
<script>
    // Create a "close" button and append it to each list item
    var itemList = document.getElementsByClassName("item-list");
    var i;
    for (i = 0; i < itemList.length; i++) {
      var span = document.createElement("SPAN");
      var txt = document.createTextNode("\u00D7");
      span.className = "item-close";
      span.appendChild(txt);
      itemList[i].appendChild(span);
    }
    
    // Click on a close button to hide the current list item
    var closeItem = document.getElementsByClassName("item-list");
    var i;
    for (i = 0; i < closeItem.length; i++) {
      var close_button = closeItem[i].children[0];
      close_button.onclick = function() {
        var current_item = this.parentNode;
        let text = current_item.innerHTML;
        let name_of_item = text.split(',')[0];
        // TODO: make this slug into pk
        var slug_name = name_of_item.toLowerCase().replace(/ /g,'-').replace(/[^\w-]+/g,'');

        function getCookie(name) {
          var cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              var cookies = document.cookie.split(';');
              for (var i = 0; i < cookies.length; i++) {
                  var cookie = jQuery.trim(cookies[i]);
                  // Does this cookie string begin with the name we want?
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');
        $.ajax({
          type: "GET",
          url: "/shop/remove-item/" + slug_name,
          datatype: "json",

          success: function (json) {
            let total_sum_string = current_item
                .parentNode
                .parentNode
                .lastChild
                .textContent;
            let amount_to_change = total_sum_string.split(":")[1];
            let amount_of_items = text.split(":")[1].split(",")[0];
            let price_per_item = text.split(":")[2].split("<")[0];
            let new_amount = parseFloat(amount_to_change).toFixed(2) - (
                parseFloat(amount_of_items).toFixed(2)*
                parseFloat(price_per_item).toFixed(2)
            );
            current_item
                .parentNode
                .parentNode
                .lastChild
                .textContent = `Total: ${new_amount}`;
            // total_amount -= (amount_of_items * price_per_item);
            let cart_modal = document.getElementById("cart-modal");
            let number_of_items_left = cart_modal
                .children[0]
                .children[0]
                .childElementCount;
            current_item.parentNode.removeChild(current_item);
            if ((number_of_items_left - 1) === 0){
              for (let key in item_dict){
                item_dict[key] = 0;
              }
              cart_modal.innerHTML = "Du har ingen varer i kurven. Kjøp noe da vel!";
            }
          },

          error: function (xhr, errmsg, err) {
              // console.log(xhr.status + ": " + xhr.responseText);
          },
      });
      }
    }
    </script>
{% endblock footer_script %}
